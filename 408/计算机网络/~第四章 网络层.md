# 4.3 IPv4

## 4.3.1 IPv4分组

### 1.IPv4分组的格式

![](2021-08-02-21-12-18.png)

### 2.IP数据报分片

**最大传输单元(MTU)**：数据链路层数据报能承载的最大数据量(以太网是1500字节)

![](2021-08-02-21-22-28.png)

## 4.2.2 IPv4地址与NAT

### 1.IPv4地址

IP地址：全世界唯一的32位/4字节标识符，标识路由器主机的接口
IP地址::=网络号，主机号

![](2021-08-02-21-49-17.png)

**特殊IP地址**
1. 主机号全0表示网络本身
2. 主机号全为1表示网络的广播地址，对特定网络上的所有主机进行广播
3. 127.0.0.0保留位环环自检地址，此地址表示任意主机本身，目的地址位环地址的IP数据包永远不会出现在任何网络上
4. 32位全0，本网络上的本主机
5. 32位全1表示整个TCP/IP网络的广播地址，又称受限广播地址。

![](2021-08-02-22-04-37.png)

### 2.网络地址转换

网络地址转换NAT：在**专用网**连接到**因特网**的路由器上安装NAT软件，安装了NAT软件的路由器将**NAT路由器**，它至少有一个有效的**外部全球IP地址**。

⚠️普通路由器在转发IP数据报时，不改变其源IP地址和目的IP地址。而NAT路由器在转发IP数据报时，一定要更换其IP地址。

## 4.3.3 子网划分与子网掩码、CIDR

### 1.子网划分

1. 子网划分纯属一个单位内部的事情。单位对外部仍然表现为没有划分子网的网络
2. 从主机号借若干比特作为子网号，当然主机号也就相应减少了相同的比特。(主机号至少两位，因为不能全0或全1)

### 2.子网掩码
1对于网络号和子网号，0对应主机号
用子网掩码与IP地址相与，就得到子网网络地址

### 3.无分类域间路由选择(CIDR)

1. 消除了传统的A、B、C类地址以及划分子网的概念
2. 融合了子网地址与子网掩码，方便子网划分
3. CIDR记法：IP地址后加上"/"，然后写上网络前缀的位数。

**构成超网**

将多个子网聚合成一个较大的子网，叫做构成超网，或路由聚合。
将网络前缀取交集

**最长前缀匹配**

从匹配结果中选择具有最长网络前缀的路由

## 4.3.4 ARP、DHCP与ICMP

### 1.IP地址与硬件地址

在网络层及网络层之上使用的是IP地址
硬件地址是数据链路层使用的地址

路由器有多个IP地址和多个硬件地址

### 2.地址解析协议(ARP)

在实际网络的链路上传送数据帧时，最终必须使用物理地址

**ARP协议**：完成主机或路由器IP地址到MAC地址的映射

**ARP协议使用过程**：检查ARP高速缓存，有对应表项则写入MAC帧，没有则用目的MAC地址为全1的帧封装并**广播请求分组**。目的主机收到请求后就会向源主机**单播一个ARP响应分组**，源主机收到后将此映射写入**ARP缓存**

**ARP协议4中典型情况**：
1. 主机A发给本网络上的主机B：用ARP找到主机B的硬件地址
2. 主机A发给另一网络的主机B：用ARP找到本网络上的一个路由器的硬件地址
3. 路由器发给本网络的主机A：用ARP找到主机A的硬件地址
4. 路由器发给另一网络的主机B：用ARP找到本网络上的一个路由器的硬件地址

### 3.动态主机配置协议(DHCP)

DHCP是**应用层**协议，使用**客户/服务器**方式，客户端和服务端通过**广播**方式进行交互，基于**UDP**

DHCP提供即插即用联网的机制，主机可以从服务器动态获取IP地址、子网掩码、默认网关、DNS服务器名称与IP地址，允许**地址重用**，支持**移动用户加入网络**，支持**在用地址续租**

**工作流程**
1. 主机广播DHCP发现报文：试图找到网络中的服务器，服务器获得一个IP地址
2. DHCP服务器广播DHCP提供报文：服务器拟分配给主机一个IP地址及相关配置，先到先得
3. 主机广播DHCP请求报文：主机向服务器请求提供IP地址
4. DHCP服务器广播DHCP确认报文：正式将IP地址分配给主机

### 4.网络控制报文协议(ICMP)

支持主机或路由器报告差错和异常情况

**差错报文**
1. 终点不可达：无法交付报文
2. 源点抑制：拥塞丢数据
3. 时间超过：生存时间(TTL)为0
4. 参数问题：首部字段有问题
5. 改变路由：可通过更好的路由

**不应该发送差错报文的情况**
1. 不会对ICMP的差错发送差错报文
2. 对第一个分片的数据报片的所有后序数据报片都不发送ICMP差错报告报文
3. 对具有组播地址(1点到多点-不是要求所有)的数据报都不发生ICMP差错报告报文
4. 对特殊地址(127.0.0.0)

**询问报文**
1. 回答请求和回答报文：测试目的站是否可达以及了解其相关状态
2. 时间戳请求和回答报文：用来进行时钟同步和测量时间