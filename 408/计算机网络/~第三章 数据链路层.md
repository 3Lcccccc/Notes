# 3.1 数据链路层的功能

## 3.1.1 数据链路层的基本概念

1. 结点：主机、路由器
2. 链路：两个结点之间的物理通道
3. 数据链路：网络中两个结点之间的逻辑通道
4. 帧：链路层的协议数据单位，封装网络层数据报

## 3.1.2 为网络提供服务

1. 无确认的无连接服务
   1. 发送方无需建立链路连接，接收方无需发送确认
2. 有确认的无连接服务
   1. 发送方无需建立链路连接，接收方必须发送确认
3. 有确认的面向连接服务
   1. 传输过程分为三个阶段
      1. 建立数据链路
      2. 传输帧
      3. 释放数据链路

⚠️有连接就一定要确认，所以不存在 无确认的面向连接服务

## 3.1.3 链路管理

数据链路层连接的建立、维持、释放过程称为链路管理。
主要用于面向连接的服务

## 3.1.4 帧定界、帧同步与透明传输

**封装成帧**：在一段数据的前后部分添加首部和尾部。接收端在收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中识别帧的开始和接收。

**帧同步**：接收方应当能从接收到的二进制比特流中区分处帧的起始和终止。

**透明传输**：不管所传数据是什么样的比特组合，都应当能过在链路上传送。


# 3.2 组帧

## 3.2.1 字符计数法

帧首部使用第一个字符作为计算字段来表明帧内字符数(包括自身)

## 3.2.2 字符填充法

利用控制字符SOH放在帧的最前面表示开始、EOT放在末尾表示结束。同时如果原始数据里有编码与控制字符一样的数据在其前面插入转义字符ESC来区分，接收方收到后会删除自己插入的转义字符

## 3.2.3 零比特填充法

在首部和尾部使用0111110来表示帧的开始与结束，同时在发送端扫描整个信息字段，如果发现5个1就在后面填入一个0，在接收方，先通过标志端确定帧，然后同样扫面整个信息字段，发现5个1就删除后面的一个0.

## 3.2.4 违规编码法

使用信息编码方式中不会使用到的编码来表示开始与结束。


# 3.3 差错控制

1. 随机噪声：提高信噪比
2. 冲击噪声：差错控制

**差错**
1. 位错
   1. 1变成0、0变成1
2. 帧错
   1. 丢失
   2. 重复
   3. 失序


## 3.3.1 检错编码

### 1. 奇偶校验码

添加1位校验元。

奇校验码：添加后，码字中"1"有奇数个
偶校验码：添加后，码字中"1"有偶数个

只能检测奇数位比特位出错，检测不了偶数位出错。

### 2. 循环冗余码(CRC)

1. 在原数据后面加上r个0(r为多项式的阶)
2. 使用加0后的数据对多项式做除法
3. 得到的余数就是冗余码(FCS)，用冗余码取代之前添加的0

**检错**：接收方使用接收到的数据除以多项式为0则无错

FCS的生成以及接收端CRC检验都是由硬件实现，处理很迅速，因此不会延误数据的传输。

## 3.3.2 纠错编码

两个合法编码的对应比特取值不同的数量称为这两个码字的**海明距离(码距)**，一个有效编码集忠，任何两个合法编码的海明距离的最小值为该编码集的**海明距离**。

如果可以检测出**n位比特出错**的话，海明距离位**n+1位**
如果可以纠正出**n位比特出错**的话，海明距离位**2n+1位**

### 海明码的工作流程

1. **确定校验码位数**：$2^r\geq m+r+1$(其中r位校验码位数，m位信息位数)
2. **确定校验码和数据的位置**：将校验码放在$2^n$的位置上。自低位向高位
3. **求出校验码的值**：根据所在位置的二进制位中的1找出负责校验的比特位有哪些，根据奇偶校验求值
4. **检错并纠错**：略

# 3.4流量控制与可靠传输机制

## 3.4.1 流量控制、可靠传输与滑动窗口机制

**可靠传输**：发送端发什么，接收端收什么。
**流量控制**：控制发送速率，使接收方有足够的缓冲空间来接收每一帧。

1. 停止-等待协议：发送窗口大小=1，接收窗口大小=1
2. 后退N帧协议：发送窗口大小为>1，接收窗口大小=1
3. 选择重传协议：发送窗口大小>1，接收窗口大小>1

## 3.4.2 停止-等待协议

发完一个帧后必须保留它的副本。
数据帧和确认帧必须编号

1. 数据帧丢失或检测到帧出错：每次发送后会启动超时计时器，超时后会重传一帧
2. ACK丢失：接收方收到超时重传的帧后会丢弃重复的帧，并且重新确认帧
3. ACK迟到：发送方收到重复确认后丢弃

👍优点：简单
👎缺点：信道利用率低

信道利用率=$\displaystyle \frac{\displaystyle \frac{发送周期内发送的比特数据}{发送方数据传输率}}{发送周期(从发送数据开到接收完第一个确认帧为止)}$

## 3.4.3 后退$N$帧协议(GBN)

发送方收到确认会滑动窗口
接收方每收到一帧便会滑动一格

发送窗口最大为$2^{n}-1$

**GBN发送方必须要相应的三件事**
1. 上层的调用
   - 上层要发送数据时，发送方先检查发送窗口是否已满，如果**未满**，则产生一个帧并将其发送；如果窗口**已满**，只需将数据返回给上层。
2. 收到了一个ACK
   - GBN协议中，对n号帧的确认采用**累计确认**的方式，表明接收方已经收到n号帧和它之前的全部帧。
3. 超时事件
   - 发送方会重传所有已发送但未被确认的帧。

**接收方要做的事情**
1. 如果正确收到n号帧，并且按序，那么接收方为n帧发送一个ACK，并将该帧中的数据部分交付给上层
2. 其余情况都丢帧，并且为最近按序接收的帧重新发送ACK

👍优点：因连续发送数据帧而提高了信道利用率
👎缺点：在重传时必须把原来已经正确传送的数据帧重传，传送效率低。

## 3.4.4 选择重传协议(SR)

**发送方必须相应的三件事**

1. 上层的调用
   1. 从上层收到数据后，发送方检查下一个可用于该帧的序号，如果序号位于发送窗口内，者发送数据帧；否则就像GBN一样，要么将数据缓存，要么返回给上层之后再传输
2. 收到了一个ACK
   1. 如果收到了ACK，该帧序号在窗口内，者发送方将那个被确认的帧标记为已接受，如果该帧序号是窗口的下界，者窗口向前移动到具有最小序号的未确认帧处，如果窗口移动了并且有序号在窗口内的未发送帧，则发送这些帧。
3. 超时事件
   1. 每个帧都有一个计时器，一个事件发生后只重传一个帧。

**接收方要做的事**
$\color{Red}{来者不拒}$(窗口内的帧)
接收方将确认一个正确接收的帧而不管其是否按序。失序的帧将被缓存，并返回给发送方一个该帧的确认帧，直到所有帧皆被收到为止，这时才可以将一批帧按序交付给上层，然后向前移动滑动窗口。

如果收到了窗口序号外的帧，就返回一个ACK(可能是之前发送的ACK丢失了，发送了超时重传)
其它情况忽视该帧

**滑动窗口大小**
发送窗口最好等于接收窗口(大了会溢出，小了没意义)
$W_{max}=2^{n-1}$
$W_发+W_收\leq 2^n$

# 3.5 介质访问控制

## 3.5.1 信道划分介质访问控制

### 1.频分多路复用(FDM)

1. 用户在分配到一定的频带后，在通信过程中自**始至终都占用**这个频带，**所有用户在同样的时间占用不同的带宽(频率带宽)资源**
2. 👍优点
   1. 充分利用传输介质带宽，系统**效率较高**
   2. 实现比较简单

### 2.时分多路复用(TDM)

1. 每一个用户在每一个TDM帧(一个周期)中占用**固定的时间**，所用用户轮流占用信道。

### 3.波分多路复用(WDM)

根据光的波长来划分信道

### 4.码分多路复用(CDM)

用不同编码来区分
