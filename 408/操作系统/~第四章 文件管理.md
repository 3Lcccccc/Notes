# 4.1 文件系统基础
## 4.1.1 文件的概念
### 1. 文件的属性

1. 名称
2. 标识符
3. 类型
4. 位置
5. 大小
6. 保护
7. 时间、日期、和用户标识

### 2. 文件的基本操作

1. 创建文件(create系统调用)
   1. 
2. 删除文件(delete系统调用)
3. 读文件(read系统调用)
4. 写文件(write系统调用)
5. 打开文件(open系统调用)
6. 关闭文件(close系统调用)

## 4.1.2 文件的逻辑结构

1. 无结构文件(流式文件)
   - 由一系列二进制或字符流组成
2. 有结构文件(记录式文件又分为定长记录和变成记录)
   1. 顺序文件
      1. 文件中的记录一个接一个地顺序排列(逻辑上)，记录可以是**定长**的或**可变长**的。各个记录在物理上可以**顺序存储**或**链式存储**
      2. 串结构：记录之间的顺序与关键字无关
      3. 顺序结构：记录之间的顺序按关键字排列
      4. ![](2021-07-05-10-31-40.png)
      5. ![](2021-07-05-10-31-49.png)
   2. 索引文件
      1. 建立一个索引表(索引号、长度、指针)
      2. 索引表本身是定长记录的顺序文件
      3. 主要用于对信息处理的及时性要求比较高的场合
      4. 👎缺点：索引表会占用而外的存储空间
   3. 索引顺序文件
      1. 将记录分组。每组对应一个索引表项
   4. 直接文件或散列文件    

## 4.1 目录结构

### 1. 文件控制块和索引结点
1. 文件控制块(FCB)
   1. 基本信息：文件名、文件的物理位置...
   2. 存取控制信息：存取权限...
   3. 使用信息：建立、修改信息...
2. 索引结点(FCB的改进)
   1. 把除了文件名以外的数据存到索引结点中，增加一个索引结点指针，降低读盘次数(目录表大小减小)，提高查询速度。

### 2. 目录结构
- 搜索
- 创建文件
- 删除文件
- 显示目录
- 修改目录
1. 单级目录结构
   - 实现了按名存取，但**不允许重名**
2. 两级目录结构
   - 早期多用户系统采用，用户不能对自己的文件进行分类
3. 多级目录结构(树形目录结构)
   - 不便于实现文件的共享
4. 无环图目录结构
   - 可以用不同的文件名指向同一个文件，甚至目录。需要为每个共享结点设置一个共享计数器。
   - ⚠️不同于复制文件，共享文件只要有一个用户修改了文件数据，那么所有用户都可以看到文件数据的变化。

## 4.1.4 文件共享

# 4.2 文件系统实现
## 4.2.1 文件系统层次结构
## 4.2.2 目录实现
## 4.2.3 文件实现——文件分配方式
**访问的两个磁盘块越远，所需(移动磁头)时间越长**
1. 连续分配
   1. 要求每个文件在磁盘上占有一组连续的块
   2. 文件目录中记录存放的起始块号和长度
   3. 👍优点：
      1. 支持顺序、随机访问
      2. 在顺序读/写速度最快
   4. 👎缺点：
      1. 不方便拓展
      2. 空间利用率低
2. 链接分配(题目中没有提及默认为隐式)
   1. 利用指针链接磁盘块
   2. 隐式
      1. 目录中记录起始块号和结束块号
      2. 👍优点：
         1. 拓展文件方便
         2. 外存利用率高
      3. 👎缺点：
         1. 只支持顺序访问，不支持随机访问
         2. 指针也需要耗费存储空间 
   3. 显式
      1. 把链接关系存放在一张文件分配表(FAT)中
      2. 一个磁盘仅设置一张FAT，开机时将其存入内存，且常驻内存。
      3. 👍优点：
         1. 支持顺序、随机访问
         2. 方便文件拓展
      4. 👎缺点：
         1. FAT也会占用内存
3. 索引分配
   1. 允许文件离散的分配在各个磁盘块中，系统会**为每个文件建立一张索引表**，索引表中**记录了文件的各个逻辑块对应的物理块**。索引表存放的磁盘块为索引块，文件数据存放的磁盘块为数据块。
   2. 目录中记录的是索引块号
   3. 👍优点：
      1. 支持顺序、随机访问
      2. 文件拓展方便
   4. 👎缺点：
      1. 索引表要占用一定空间
   5. 索引表太大一个磁盘块存不下
      1. 链接方案
         1. 利用指针将磁盘块链接起来
         2. 读盘次数过多、查找效率低
      2. 多层索引
         1. 采用k层索引结构，且顶层索引表没有被调入内存，需要k+1次读盘
         2. 即使是小文件也需要k+1次读盘
      3. 混合索引
         1. 多级索引的结合
         2. 索引表中有直接索引(直接指向数据)、一级间接索引(单层索引表)二级间接索引

## 4.2.4 文件存储空间管理

**连续的空闲盘块组成一个盘区(单个盘块也算)**

1. 存储空间的划分与初始化
   1. 一个文件卷中被划分成目录区和文件区(通常一个物理盘对应一个文件卷)
2. 空间管理
   1. 空闲表法
      1. 系统建立一张空闲块表，每个**盘区**对应一个空闲表项
      2. 表中记录第一个空闲盘块号和空闲盘块数
   2. 空闲链表法
      1. **操作系统需要保存链头和链尾**
      2. 空闲盘块链
         1. 以盘块为单位组成一条空闲链
         2. 回收时将盘块依次挂到链尾
      3. 空闲盘区链
         1. 以盘区为单位组成一条空闲链
         2. 第一个盘块记录了盘区的长度和下一个盘区的指针
         3. 回收时如果周围没有相邻的空闲盘区则作为单独的盘区挂到链尾
   3. 位示图法
      1. $盘块号=字长*字号+位号$
      2. $字号=\frac{盘块号}{字长}$
      3. $位号=\frac{盘块号}{字长}$
   4. 成组链接法
      1. 在文件目录中专门用一个磁盘块作为"超级块"，系统启动时读入内存，且要保证内存与外存的超级快数据一致
      2. 超级块中记录了下一组空闲盘块数和所有空闲盘块号
      3. 超级块的一个的块也会记录下一组空闲盘块数和所有空闲盘块号以-1为结尾
      4. 如果超级块中的空闲块分配完了，将下一组复制到超级块中
      5. 如果回收时的空闲块数，超级块中放不下了，则让新回收的块成为超级快的下一组，并且把超级快中的空闲块尽可能的转移过去