# 中央处理器

## CPU的功能和基本结构

### CPU的功能

- 指令控制
- 操作控制
- 时间控制
- 数据加工
- 中断处理

### CPU的基本结构

- **运算器**
  - 算术逻辑单元
  - 暂存寄存器
  - 累加寄存器
  - 通用寄存器组
  - 程序状态字寄存器
    - 溢出标志(OF)
    - 符号标志(SF)
    - 零标志(ZF)
    - 进位标志(CF)
  - 移位器
  - 计数器
- **控制器**
  - 程序计数器
  - 指令寄存器
  - 指令译码器
  - 存储器地址寄存器
  - 存储器数据寄存器
  - 时序器
  - 微操作信号发生器

### 指令执行过程

### 指令周期的数据流
- 取值周期
  - **PC**$\rightarrow$**MAR**$\rightarrow$**地址总线**$\rightarrow$**主存**
  - **CU发出控制信号**$\rightarrow$**控制总线**$\rightarrow$**主存**
  - **主存**$\rightarrow$**数据总线**$\rightarrow$**MDR**$\rightarrow$**IR**
  - **CU发出读命令**$\rightarrow$**(PC)+"1"**
- 间址周期
  - **Ad(IR)** 或者 **MDR**$\rightarrow$**MAR**$\rightarrow$**地址总线**$\rightarrow$**主存**
  - **CU发出读命令**$\rightarrow$**控制总线**$\rightarrow$**主存**
  - **主存**$\rightarrow$**数据总线**$\rightarrow$**MDR**
- 执行周期
  - 执行的操作不同,数据流向也不同
- 中断周期
  - 将程序断点存入堆栈中,并用SP指向栈顶地址
  - **CU控制将SP减1,SP**$\rightarrow$**MAR**$\rightarrow$**地址总线**$\rightarrow$**主存**
  - **CU发出写命令**$\rightarrow$**控制总线**$\rightarrow$**主存**
  - **PC**$\rightarrow$**MDR**$\rightarrow$**数据总线**$\rightarrow$**主存**(程序断点存入主存)
  - **CU**$\rightarrow$**PC**

###　指令执行方案

- 单指令周期
  - 对所有指令都选用相同的执行时间来完成
- 多指令周期
  - 对不同类型的指令选用不同的执行步骤来完成
- 流水线方案

## 数据通路的功能和基本结构
### 硬布线控制器
- 特点:快,一般用于RISC,不易改动
### 微程序控制器
- 基本概念
  - 微操作:一条指令可以拆分多个微操作
  - 微命令:控制信号
  - 微指令:若干微命令的集合
  - 微周期:读取并执行一条微指令所需的时间
  - 控制存储器:在CPU内部,用ROM实现
  - 微程序:微指令的有序集合,一条指令的功能由一段微程序来实现
- 编码方式
  - 直接编码方式
    - 在微指令的操作控制字段中，每一位代表一个微操作命令。
    - 优点:简单、直观，执行速度快，操作并行性好。
    - 缺点:微指令字长过长，n个微命令就要求微指令的操作字段有n位，造成控存容量极大。
  - 字段直接编码方式
- 指令的格式
  - 水平型
    - 一条微指令能定义多个可并行的微命令。
    - 优点:微程序短，执行速度快。
    - 缺点:微指令长，编写微程序比较麻烦。
  - 


## 指令流水线

### 流水线的分类
- 部件功能级、处理机级和处理机间级
- 单功能和多功能
- 动态和静态
  - 静态：只能按同一种功能的连接方式工作
  - 动态：当某些段正在实现某种运算时，另一种段缺在进行另一种运算。提高效率但控制变得复杂
- 线性和非线性
  - 是否存在反馈回路

### 影响流水线的因素
- **资源冲突**：同一时刻争用同一资源形成的冲突
  - 前一条指令访存时，使后一条指令暂停一个时钟周期
  - 单独设置数据存储器和指令存储器
- **数据冲突**：下一条指令会用到当前指令计算出的结果
  - 分类：
    - 写后读
    - 读后写
    - 写后写
  - 解决办法：
    - 与数据相关的指令及其后序指令都暂停**若干时钟周期**
    - 设置相关专用通路，在计算完后直接送到下一条需要的指令，不需要等写回和读取
    - 通过编译器优化，调整指令顺序
- **控制冲突**：执行转移、调用、返回时改变PC值引起的**控制冒险**
  - 进行分支预测，尽早生成转移目标地址
  - 预取转移成功和不成功两个控制流方向上的目标指令
  - 加快和提前形成条件码
  - 提高转移方向的猜准率

### 性能分析
- **吞吐量**
  - $\frac{处理任务的个数}{所用时间}$
- **加速比**
  - $\frac{不使用流水线所需时间}{使用流水线所需时间}$
- **效率**
  - $\frac{n个任务占用k时空区有效面积}{n个任务所用的时间与k个流水段所围成的时空区总面积}$