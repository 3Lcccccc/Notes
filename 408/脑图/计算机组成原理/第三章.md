# 存储系统

## 性能指标
- 存储容量
- 单位成本
  - $\frac{总成本}{总容量}$
- 存储速度
- 存取时间
  - 从启动一次存储器到完成该操作所经历的时间
- 存取周期
  - 连续两次独立访问存储器操作之间所需的最小时间间隔
- 主存带宽

## 半导体随机存储器

- SRAM
  - 静态随机存储器
  - 利用双稳态触发器(MOS管)来记忆信息
  - 集成度低
  - 速度更快
- DRAM
  - 动态随机存储器
  - 利用晶体管来记忆信息
  - 使用地址复用技术(地址线是原本的一半)
  - 每隔一段时间需要刷新存储器中的信息(一般为2$ms$)
    - 集中刷新
      - 在一个刷新周期内使用一段固定的时间进行刷新,存在"死时间"
    - 分散刷新
      - 把每行的刷新分散到各个工作周期中,不存在"死时间"
    - 异步刷新
      - 利用逻辑电路每隔时间t产生一次刷新请求
      - $t=\frac{刷新周期}{行数}$
    - 刷新时不需要选片
- 内部结构
  - 存储体
  - 地址译码器
  - $I/O$控制电路
  - 片选控制信号
    - 发出电信号选中特定的芯片
  - 读$/$写控制信号
## 主存储器的基本组成
- 针脚计算
  - 地址线数+数据线数+(读写控制线+片选线)

## 主存储器与CPU的连接

- 主存容量的扩展
  - 位扩展
    - 使数据位数与数据总线数相等
    - 片选线需连接到所有芯片，因为需要选中所有芯片
  - 字扩展
    - 通过片选信号或采用译码器设计连接到相应的芯片
  - 同时扩展
- 存储芯片的地址分配和片选
  - 线选法
    - 直接通过地址线选择芯片
    - 优点：不需要地址译码器，线路简单
  - 译码片选法
    - 通过译码器产生片选信号

## 双端口RAM和多模块存储器

- 双端口RAM
  - 两个端口对同一主存操作有以下4种情况
    - 端口**不同**，对同一地址单元**存取**数据
    - 端口**相同**，对同一地址单元**读取**数据
    - 端口**相同**，对同一地址单元**写入**数据
    - 端口**相同**，对同一地址单元一个写入，一个读取
    - 后两个会出错
    - 通过"忙"信号，由判断逻辑决定暂时关闭一个端口
- 多模块存储器
  - 单体多字存储器
    - 同时读取多个字
    - 缺点：指令和数据必须在主存内连续存放
  - 多体并行存储器
    - 高位交叉编址
      - 用高位来表示存储器号，低位表示存储器内地址
      - CPU总是按顺序访问存储模块，存储模块不能并行访问，不能提高吞吐率
      - 不符合局部性原理
    - 低位交叉编址
      - 用低位来表示存储器号，高位表示存储器内地址
      - 为实现流水线存储器模块数应**大于**$\frac{存取周期}{总线传送周期}$

## 高速缓冲存储器

### Cache行的基本构成

- *标志位=主存地址位数-块内地址位数-块号(组号)
  - 影响因素：
    - 主存的物理地址
    - Cache总行数
    - 块大小
    - 映射方式
- *有效位=1bit
- 替换算法辅助位
  - FIFO=Nbit
  - LRU=Nbit
    - 全相联$N=\log_2总行数$
    - 组相联$N=\log_2路数$
- 脏位
- 块号=采用直接映射才有
- 组号=采用组相联才有
- 块数据
- *块内地址

### Cache的基本工作原理

- 为便于信息的交换，Cache与主存都被划分为相等的块(Cache中又称为行)
- 当CPU发出**读**请求时
  - 若访存地址在Cache中命中,就将此地址转换成Cache的地址
  - 若不命中,则仍需访问主存,并把此字所在的块一次性地从主存调入Cache
- 当CPU发出**写**时
  - 若命中时通过一定策略将Cache和主存更改
- 命中率$=\frac{命中次数}{访存总次数}$
- 总容量$=($标志位$+$标记字段$+$行容量)$\times$行数
### Cache和主存的映射方式
- 直接映射
  - 标志位$+$块号$+$块内地址
  - 每个主存块只能放在对应的位置。
  - **Cache块号=主存块号%Cache总块数**
  - 优点：查找速度快，对于任意一个地址只需要查找一个标记。
  - 缺点：空间利用率低，命中率低。
- 全相联映射
  - 标志位$+$块内地址
  - 主存块可以放在Cache的任意位置。
  - 优点：空间利用率高，命中率高。
  - 缺点：查找速度慢,消耗额外空间高。
- 组相联映射
  - 标志位$+$组号$+$块内地址
  - 将Cache分成若干组，组间采用直接映射,组内采用全相联。
  - **组号=主存块号%分组数**。
  - 折中，综合效果好。

### Cache中主存块的替换算法
- 只有全相联和组相联才需要使用,使用直接映射时直接替换Cache中的数据即可
- 随机算法(RAND)
  - 随机确定需要替换的Cache块
  - 实现简单,命中率低
- 先进先出算法(FIFO)
  - 选择最早调入的行进行替换
  - 不符合局部性原理,比较容易实现
- 近期少使用算法(LRU)
  - 设置一个计数器来确定最少使用的Cache块
  - 计数器变化规则
    - 将命中的行的计数器清零,比其低的计数器加$1$
    - 未命中还有空闲行时,新装入行的计数器置$0$,其余全加$1$
    - 未命中且无空闲行,最大的被替换,其余加$1$
- 最不经常使用算法
  - 设置一个计数器从$0$开始
  - 每次访问到计数器加$1$
  - 需要替换时,将最小的换出

### Cache写策略
- 写命中
  - 全写法
    - 同时向Cache和主存写入
    - 缺点:增加了访存次数,降低了Cache的效率
  - 写回法
    - 只有将被替换时才将Cache的内容写回主存
    - 需要增加一个脏位来标记是否被CPU更改
- 写不命中
  - 写分配法
    - 